---
phase: 01-weather-enhancement
plan: 04
type: execute
wave: 3
depends_on: ["01-03"]
files_modified:
  - fishing-app/js/app.js
  - fishing-app/css/style.css
  - fishing-app/sw.js
autonomous: false

must_haves:
  truths:
    - "User can open the app, see today expanded, and all thematic groups render without errors"
    - "User can tap to expand/collapse each of the 7 days"
    - "Sparkline chart renders correctly with colored zones and now marker"
    - "For a coastal location, marine section and tidal chart are visible"
    - "For an inland location, no marine section appears"
    - "Service worker caches the new JS files"
  artifacts:
    - path: "fishing-app/sw.js"
      provides: "Updated cache list including marine.js, sparkline.js, tidal-chart.js"
      contains: "sparkline.js"
  key_links:
    - from: "fishing-app/sw.js"
      to: "fishing-app/js/sparkline.js"
      via: "cache file list"
      pattern: "sparkline\\.js"
---

<objective>
Final integration testing, service worker update, and visual verification of the complete Phase 1 weather enhancement.

Purpose: Ensure all pieces work together end-to-end: API calls return data, charts render correctly, accordion functions properly, coastal/inland detection works, and the service worker caches the new files for offline use.

Output: Updated service worker, any bugfixes found during testing, and human verification that the UI matches the locked decisions.
</objective>

<execution_context>
@C:\Users\Lucas Benutzer\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Lucas Benutzer\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-weather-enhancement/01-01-SUMMARY.md
@.planning/phases/01-weather-enhancement/01-02-SUMMARY.md
@.planning/phases/01-weather-enhancement/01-03-SUMMARY.md
@fishing-app/sw.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update service worker and integration fixes</name>
  <files>
    fishing-app/sw.js
    fishing-app/js/app.js
    fishing-app/css/style.css
  </files>
  <action>
**Service Worker (sw.js) updates:**

1. Update the cache version string (e.g., from 'petri-heil-v1' to 'petri-heil-v2') to force cache refresh.

2. Add the new JS files to the app shell cache list:
   - `'js/marine.js'`
   - `'js/sparkline.js'`
   - `'js/tidal-chart.js'`

3. Add the Marine API base URL to the API cache pattern so marine data is cached for offline:
   - The existing SW likely caches Open-Meteo weather API responses
   - Add `marine-api.open-meteo.com` to the same caching pattern

**Integration verification and fixes:**

After updating the SW, serve the app locally and verify:

1. Open a terminal and start a local server: `npx serve fishing-app` or `python -m http.server 8000 --directory fishing-app`

2. Open the app in browser and check the console for errors:
   - No "X is not defined" errors (all functions accessible globally)
   - No "Cannot read property of null" errors (all DOM elements exist)
   - Weather API call succeeds (check Network tab)
   - Marine API call is attempted (may return isCoastal: false for inland locations like Salzburg)

3. Fix any issues found:
   - If functions aren't globally accessible, ensure they're not wrapped in IIFEs incorrectly
   - If canvas rendering fails, check that canvas elements exist in DOM before drawing
   - If data is missing, verify API param names match Open-Meteo documentation exactly
   - If pressure sparkline shows no data for today, verify past_days=1 produces extra hourly entries

4. Verify the accordion still functions:
   - Today should auto-expand on load
   - Clicking a collapsed day expands it
   - Clicking an expanded day collapses it
   - Sparkline draws on today's expand (should be already drawn since today starts expanded)

**Test with coastal location:**

Set location to a known coastal city to test marine features:
- Use "Split, Kroatien" or "Zadar, Kroatien" (Adriatic coast, relevant to user's fishing context)
- Verify Marine API returns data
- Verify Marine group appears in accordion
- Verify tidal chart renders

**Test with inland location:**

Set location back to "Salzburg, Oesterreich":
- Verify Marine API returns { isCoastal: false }
- Verify NO Marine group appears in accordion
- Verify only 7 factor bars show (not 9)
  </action>
  <verify>
    - sw.js has updated cache version
    - sw.js cache list includes marine.js, sparkline.js, tidal-chart.js
    - App loads without JS console errors
    - Accordion expands/collapses correctly
    - Sparkline renders for today
    - No broken UI elements
  </verify>
  <done>
    Service worker updated with new files. App loads cleanly without errors. Accordion works correctly with all thematic groups rendering properly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Phase 1 Weather Enhancement:
    - 7-day accordion with 5 thematic groups per day (Wind & Wetter, Luftdruck, Sonne & Mond, Marine, Fangprognose)
    - 48h pressure sparkline with colored zones and "now" marker
    - Marine/tidal data for coastal locations with graphical timeline
    - Enhanced fishing score (7 inland / 9 coastal factors)
    - Best fishing time recommendation per day
    - Moon rise/set times
    - Wind gusts, UV index, visibility data
  </what-built>
  <how-to-verify>
    1. Open the app (serve from fishing-app/ directory)

    2. **Inland test (default Salzburg):**
       - Tap "Vorhersage" tab to see 7-day accordion
       - Verify today is expanded, showing 4 groups (Wind & Wetter, Luftdruck, Sonne & Mond, Fangprognose -- NO Marine)
       - Check Wind & Wetter shows: weather, wind, gusts, temp, precip, UV index, visibility
       - Check Luftdruck shows: pressure value, trend arrow, and sparkline graph with colored zones
       - Check Sonne & Mond shows: sunrise, sunset, moon phase, moon rise, moon set
       - Check Fangprognose shows: score badge, "Beste Angelzeit: HH:MM - HH:MM", solunar badges, 7 factor bars
       - Collapse today, expand another day -- verify groups appear correctly

    3. **Coastal test:**
       - Search for "Split" or "Zadar" (Croatian coast)
       - Go to Vorhersage tab
       - Verify today now shows 5 groups including "Marine & Gezeiten"
       - Marine group should show wave height, wave period, and tidal timeline chart
       - Fangprognose should show 8-9 factor bars (including Gezeiten and Wellen)

    4. **Collapsed view check:**
       - In the accordion, verify each collapsed row shows: weekday, weather icon, temp range, precipitation, wind speed, pressure trend arrow, score badge

    5. **Sparkline check:**
       - In Luftdruck group (today), verify the sparkline graph has:
         - A blue pressure line
         - Colored background zones (green/orange/red)
         - A vertical "now" marker line
         - Min/max hPa labels

    6. Report any visual issues, misaligned elements, or missing data
  </how-to-verify>
  <resume-signal>Type "approved" if everything looks correct, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. Service worker caches all new files
2. App loads without errors for inland and coastal locations
3. All 13 WETTER requirements are visually verifiable
4. Accordion functions correctly (expand/collapse)
5. Charts render without errors
6. Marine section only appears for coastal locations
</verification>

<success_criteria>
Phase 1 is complete when:
- Human verifies the accordion UI matches the locked decisions
- All thematic groups render correctly
- Sparkline and tidal charts are visually correct
- Inland/coastal detection works as expected
- No console errors during normal use
</success_criteria>

<output>
After completion, create `.planning/phases/01-weather-enhancement/01-04-SUMMARY.md`
</output>
