---
phase: 01-weather-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fishing-app/js/config.js
  - fishing-app/js/api.js
  - fishing-app/js/solunar.js
  - fishing-app/js/marine.js
autonomous: true

must_haves:
  truths:
    - "Weather API returns wind gusts, UV index, and visibility data per hour"
    - "Weather API returns 48h of pressure data (24h past + 24h future) in a single call"
    - "Marine API is called and returns wave/sea level data for coastal locations"
    - "Inland locations get isCoastal: false without error or UI disruption"
    - "Fishing score uses 7 factors for inland, 9 factors for coastal, all summing to 100%"
    - "Moon rise/set times are calculated for each day"
    - "Best fishing time recommendation is calculated per day"
  artifacts:
    - path: "fishing-app/js/config.js"
      provides: "Extended WEATHER_PARAMS with wind_gusts_10m, uv_index, past_days; new MARINE_PARAMS; new CATCH_WEIGHTS_INLAND and CATCH_WEIGHTS_COASTAL; Marine API endpoint"
      contains: "MARINE_PARAMS"
    - path: "fishing-app/js/api.js"
      provides: "fetchWeatherData with past_days and new params; fetchMarineData function; pressureHistory in weather response"
      exports: ["fetchWeatherData", "searchLocation", "getCurrentLocation", "fetchMarineData"]
    - path: "fishing-app/js/solunar.js"
      provides: "getMoonRiseSet function; enhanced calculateCatchProbability with dynamic weights; uvIndexScore, visibilityScore, tideTimingScore, waveHeightScore; calculateBestFishingTime"
      exports: ["getMoonData", "getMoonRiseSet", "getSolunarPeriods", "calculateCatchProbability", "calculateBestFishingTime"]
    - path: "fishing-app/js/marine.js"
      provides: "extractTideTimes from hourly sea level data; parseMarineDaily for per-day summaries"
      exports: ["extractTideTimes", "parseMarineDaily"]
  key_links:
    - from: "fishing-app/js/api.js"
      to: "fishing-app/js/config.js"
      via: "CONFIG.WEATHER_PARAMS and CONFIG.MARINE_PARAMS"
      pattern: "CONFIG\\.WEATHER_PARAMS|CONFIG\\.MARINE_PARAMS"
    - from: "fishing-app/js/solunar.js"
      to: "fishing-app/js/config.js"
      via: "CATCH_WEIGHTS_INLAND and CATCH_WEIGHTS_COASTAL"
      pattern: "CATCH_WEIGHTS_INLAND|CATCH_WEIGHTS_COASTAL"
    - from: "fishing-app/js/api.js"
      to: "https://marine-api.open-meteo.com"
      via: "fetchMarineData function"
      pattern: "marine-api\\.open-meteo\\.com"
---

<objective>
Enhance the data layer with new weather parameters, Marine API integration, tide calculation, moon rise/set times, and rebalanced fishing score system.

Purpose: This is the data foundation for all Phase 1 UI enhancements. Without the correct API calls, data parsing, and score calculations, the UI has nothing to display. All new weather parameters (wind gusts, UV, visibility, marine data, pressure history) and scoring logic must be wired before the UI can render them.

Output: Updated config.js, api.js, solunar.js, and new marine.js with all data-layer logic for Phase 1.
</objective>

<execution_context>
@C:\Users\Lucas Benutzer\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Lucas Benutzer\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-weather-enhancement/01-RESEARCH.md
@fishing-app/js/config.js
@fishing-app/js/api.js
@fishing-app/js/solunar.js
@fishing-app/js/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend config.js and api.js with new weather + Marine API parameters</name>
  <files>
    fishing-app/js/config.js
    fishing-app/js/api.js
  </files>
  <action>
**config.js changes:**

1. Add Marine API endpoint to CONFIG.API:
   ```
   MARINE: 'https://marine-api.open-meteo.com/v1/marine'
   ```

2. Extend CONFIG.WEATHER_PARAMS.hourly array -- add these three entries:
   - `'wind_gusts_10m'`
   - `'uv_index'`
   Keep `'visibility'` (already present).

3. Add `past_days: 1` to CONFIG.WEATHER_PARAMS (enables 24h historical data for pressure graph).

4. Add CONFIG.MARINE_PARAMS object:
   ```javascript
   MARINE_PARAMS: {
       hourly: [
           'wave_height',
           'wave_direction',
           'wave_period',
           'swell_wave_height',
           'ocean_current_velocity'
       ].join(','),
       daily: 'wave_height_max,wave_direction_dominant',
       forecast_days: 7
   }
   ```

5. Replace the old CATCH_WEIGHTS with two new weight sets. Keep the old CATCH_WEIGHTS unchanged for backward compatibility (existing code still references it), but add:
   ```javascript
   const CATCH_WEIGHTS_INLAND = {
       moonPhase: 0.20,
       solunar: 0.25,
       pressure: 0.18,
       timeOfDay: 0.12,
       cloudCover: 0.10,
       uvIndex: 0.08,
       visibility: 0.07
   };

   const CATCH_WEIGHTS_COASTAL = {
       moonPhase: 0.18,
       solunar: 0.22,
       pressure: 0.16,
       timeOfDay: 0.10,
       cloudCover: 0.09,
       uvIndex: 0.07,
       visibility: 0.06,
       tides: 0.08,
       waveHeight: 0.04
   };
   ```

6. Update the module.exports line at the bottom to include all new constants.

**api.js changes:**

1. In `fetchWeatherData()`: The function already spreads `CONFIG.WEATHER_PARAMS` which will now include `past_days: 1`, `wind_gusts_10m`, and `uv_index`. Extend the hourly parsing loop to include new fields:
   - Add `windGusts: data.hourly.wind_gusts_10m[idx]`
   - Add `uvIndex: data.hourly.uv_index[idx]`
   - Add `visibility: data.hourly.visibility[idx]` (already present in API params but not parsed into hourly objects)

2. Extract 48h pressure history from the raw API response. Because `past_days: 1` adds ~24 extra hours at the beginning, the raw data now starts 24h before today midnight. Build a `pressureHistory` array:
   ```javascript
   const pressureHistory = data.hourly.time.map((time, i) => ({
       time: time,
       value: data.hourly.pressure_msl[i]
   }));
   ```
   Add `pressureHistory` to the returned WeatherData object.

3. Also add to the returned WeatherData:
   - `windGusts: data.current.wind_gusts_10m` (if available in current, otherwise from hourly at currentIndex)
   - `uvIndex: data.hourly.uv_index[currentIndex]` (UV not in current block, use hourly)
   - `visibility: data.hourly.visibility[currentIndex]`

4. Extend daily parsing to include: `uv_index_max`, `wind_gusts_10m_max`. Add these to CONFIG.WEATHER_PARAMS.daily array first. Then parse them:
   - `uvIndexMax: data.daily.uv_index_max[i]`
   - `windGustsMax: data.daily.wind_gusts_10m_max[i]`

5. Create new `fetchMarineData(location)` function following the pattern from RESEARCH.md:
   - Build params from CONFIG.MARINE_PARAMS + location lat/lon
   - Call Marine API endpoint
   - If response is OK and has wave_height data with non-null values, return `{ isCoastal: true, hourly: data.hourly, daily: parsed daily array }`
   - If response fails, is empty, or all wave_height values are null, return `{ isCoastal: false }`
   - Use `fetchWithRetry(url, 2)` (only 2 retries for optional data)
   - Wrap entire function in try/catch -- any error returns `{ isCoastal: false }`
   - Log warnings to console on failure: `console.warn('Marine API unavailable, treating as inland:', err)`

6. Update module.exports to include `fetchMarineData`.

**IMPORTANT:** Do NOT modify `wind_gusts_10m` in current params -- it may not be available in the `current` block. Check if `data.current.wind_gusts_10m` exists; if not, fall back to hourly at currentIndex.
  </action>
  <verify>
    - Open fishing-app/js/config.js and confirm: MARINE_PARAMS exists, CATCH_WEIGHTS_INLAND has 7 keys summing to 1.0, CATCH_WEIGHTS_COASTAL has 9 keys summing to 1.0, WEATHER_PARAMS.hourly includes wind_gusts_10m and uv_index, past_days: 1 is set
    - Open fishing-app/js/api.js and confirm: fetchMarineData function exists, fetchWeatherData returns pressureHistory array, hourly items include windGusts/uvIndex/visibility, returned WeatherData includes windGusts/uvIndex/visibility at top level
    - Verify weight sums: Object.values(CATCH_WEIGHTS_INLAND).reduce((a,b)=>a+b) === 1.0 (within floating point tolerance)
    - Verify weight sums: Object.values(CATCH_WEIGHTS_COASTAL).reduce((a,b)=>a+b) === 1.0 (within floating point tolerance)
  </verify>
  <done>
    config.js has Marine API endpoint, new WEATHER_PARAMS (with past_days, wind_gusts, uv_index), MARINE_PARAMS, and two new weight sets (CATCH_WEIGHTS_INLAND, CATCH_WEIGHTS_COASTAL). api.js has fetchMarineData and returns enhanced WeatherData with pressureHistory, windGusts, uvIndex, visibility. Daily forecasts include uvIndexMax and windGustsMax.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create marine.js and enhance solunar.js with moon rise/set, scoring, and best time</name>
  <files>
    fishing-app/js/marine.js
    fishing-app/js/solunar.js
    fishing-app/index.html
  </files>
  <action>
**Create fishing-app/js/marine.js (new file):**

Follow existing codebase conventions: JSDoc header, functions with JSDoc params/returns, CommonJS export at bottom.

1. `extractTideTimes(hourlyData)` function:
   - Input: object with `time` array (ISO strings) and `wave_height` array (can contain nulls). Note: Open-Meteo Marine API may not provide sea_surface_height directly. Use wave_height pattern analysis as proxy, OR if the API provides a sea-level-like field, use that. Based on research, use the hourly data to find tide patterns.
   - Actually, per the research, tides should be derived from sea level height. However, Open-Meteo Marine may not provide `sea_surface_height`. The research acknowledges this uncertainty. Implement a pragmatic approach:
     - If hourly data contains a field with sea-level or height data, use peak detection (local maxima = high tide, local minima = low tide)
     - Group results by day (YYYY-MM-DD)
     - Return array of `{ date: string, tides: [{ time: ISO, height: number, type: 'high'|'low' }] }`
   - Handle null values gracefully (skip them in peak detection)
   - If no valid tide data can be extracted, return empty array

2. `parseMarineDaily(marineData)` function:
   - Input: raw Marine API response (the `marineData` returned by fetchMarineData when isCoastal is true)
   - Extracts per-day marine summary: date, waveHeightMax, wavePeriodAvg, waveDirectionDominant
   - Returns array of `{ date, waveHeightMax, wavePeriodAvg, waveDirectionDominant }`

3. Add CommonJS export at bottom: `extractTideTimes`, `parseMarineDaily`

**Enhance fishing-app/js/solunar.js:**

1. Add `getMoonRiseSet(date, lat, lon)` function:
   - Extend the existing Julian day + moon transit calculation (estimateMoonTransit is already in this file)
   - Approximate moon rise as transit - 6h, moon set as transit + 6h (same approximation already used in getSolunarPeriods for moonrise/moonset)
   - Return `{ rise: "HH:MM", set: "HH:MM", transit: "HH:MM" }` using existing `formatDecimalHour()`

2. Add new scoring functions (place them near existing pressureScore, timeOfDayScore, cloudCoverScore):

   `uvIndexScore(uvIndex)`:
   - UV 0-2: return 100 (low UV, fish feed freely)
   - UV 3-5: return 80
   - UV 6-7: return 60
   - UV 8+: return 40 (high UV, fish go deep)

   `visibilityScore(visibilityMeters)`:
   - Note: Open-Meteo returns visibility in METERS, not km. Convert: visibilityKm = visibilityMeters / 1000
   - visibility > 10km: return 60
   - visibility 5-10km: return 80 (slightly reduced = good, fish less cautious)
   - visibility < 5km: return 70

   `tideTimingScore(tides, currentDate)`:
   - tides = array of { time: ISO, height, type } for the day
   - For each tide event, compute hours difference from currentDate
   - If within 1h of any tide change: return 90 (high) or 85 (low)
   - If within 2h: return 70
   - Otherwise: return 50

   `waveHeightScore(waveHeightM)`:
   - 0-0.5m: return 90 (calm)
   - 0.5-1.5m: return 100 (ideal light chop)
   - 1.5-3m: return 70 (moderate)
   - 3+m: return 30 (rough)

3. Modify `calculateCatchProbability(weather, moon, solunar, fish, marineData)`:
   - Add optional 5th parameter `marineData` (object with isCoastal, tides, waveHeight properties)
   - Determine if coastal: `const isCoastal = marineData && marineData.isCoastal`
   - Calculate new factor scores: uvIndexScore(weather.uvIndex), visibilityScore(weather.visibility)
   - If coastal, also calculate: tideTimingScore(marineData.tides), waveHeightScore(marineData.waveHeight)
   - Use dynamic weights: `const weights = isCoastal ? CATCH_WEIGHTS_COASTAL : CATCH_WEIGHTS_INLAND`
   - Build scores object with all factors
   - Compute weighted average using the dynamic weights
   - IMPORTANT: The old CATCH_WEIGHTS still exists. The function should check: if CATCH_WEIGHTS_INLAND exists (typeof !== 'undefined'), use new system; otherwise fall back to old CATCH_WEIGHTS for backward compatibility
   - Update the breakdown object to include ALL computed factor scores (not just the original 5)
   - Add `isCoastal: isCoastal` to the return object
   - Keep existing fish-specific adjustments working

4. Add `calculateBestFishingTime(daySolunar, sunrise, sunset, tides)`:
   - Input: solunar periods for the day, sunrise/sunset ISO strings, optional tides array
   - Logic: Score each hour 0-23 based on:
     a. Is it within a major solunar period? +40 points
     b. Is it within a minor solunar period? +20 points
     c. Is it within 1h of dawn or dusk? +25 points
     d. Is it within 1h of a tide change (if coastal)? +15 points
   - Find the contiguous block of 2+ hours with the highest average score
   - Return `{ start: "HH:MM", end: "HH:MM" }` as the recommended window
   - German format, e.g., "06:00" to "10:00"

5. Update module.exports to include: getMoonRiseSet, calculateBestFishingTime

**Update fishing-app/index.html:**

Add the new marine.js script tag BEFORE app.js (after solunar.js in load order):
```html
<script src="js/marine.js" defer></script>
```

The load order becomes: config -> utils -> api -> solunar -> marine -> storage -> map -> fish-ui -> app
  </action>
  <verify>
    - Open fishing-app/js/marine.js and confirm: extractTideTimes and parseMarineDaily functions exist with JSDoc
    - Open fishing-app/js/solunar.js and confirm: getMoonRiseSet returns {rise, set, transit}; uvIndexScore, visibilityScore, tideTimingScore, waveHeightScore exist; calculateCatchProbability accepts 5th param marineData; calculateBestFishingTime returns {start, end}
    - Open fishing-app/index.html and confirm: marine.js script tag is between solunar.js and storage.js
    - Verify calculateCatchProbability still works WITHOUT marineData (backward compat): calling with 4 args should use CATCH_WEIGHTS_INLAND
    - Verify CATCH_WEIGHTS_INLAND weight keys match the scores object keys in calculateCatchProbability
  </verify>
  <done>
    marine.js exists with tide extraction and marine data parsing. solunar.js has moon rise/set calculation, 4 new scoring functions, enhanced calculateCatchProbability with dynamic inland/coastal weights, and calculateBestFishingTime. index.html loads marine.js in correct order. All existing functionality remains backward-compatible.
  </done>
</task>

</tasks>

<verification>
1. CONFIG.WEATHER_PARAMS includes wind_gusts_10m, uv_index, past_days: 1
2. CONFIG.MARINE_PARAMS is defined with wave parameters
3. CATCH_WEIGHTS_INLAND (7 factors) and CATCH_WEIGHTS_COASTAL (9 factors) both sum to 1.0
4. fetchMarineData exists and handles errors gracefully (returns {isCoastal: false})
5. fetchWeatherData returns pressureHistory array and new fields (windGusts, uvIndex, visibility)
6. getMoonRiseSet returns rise/set/transit times
7. calculateCatchProbability works with and without marineData (backward compatible)
8. calculateBestFishingTime returns a time window
9. extractTideTimes handles null values and returns structured tide events
10. marine.js is loaded in correct script order in index.html
</verification>

<success_criteria>
All 13 WETTER requirements have their data-layer support:
- WETTER-03 (wind gusts): windGusts in API response
- WETTER-04 (solunar): existing + enhanced
- WETTER-06 (moon rise/set): getMoonRiseSet
- WETTER-07 (UV + visibility): in API response + scoring
- WETTER-08 (marine/waves): fetchMarineData + parseMarineDaily
- WETTER-10 (tides): extractTideTimes
- WETTER-11 (fishing score): enhanced calculateCatchProbability
- WETTER-12 (48h pressure): pressureHistory in API response
- WETTER-13 (API accuracy): past_days + Marine API
</success_criteria>

<output>
After completion, create `.planning/phases/01-weather-enhancement/01-01-SUMMARY.md`
</output>
