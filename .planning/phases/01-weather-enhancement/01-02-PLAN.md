---
phase: 01-weather-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - fishing-app/js/sparkline.js
  - fishing-app/js/tidal-chart.js
autonomous: true

must_haves:
  truths:
    - "48h pressure sparkline renders on a canvas element with correct line shape"
    - "Pressure graph shows color-coded background zones (green=falling, orange=stable, red=rising)"
    - "A 'now' marker (vertical dashed line) appears at the correct position on the pressure graph"
    - "Min/max hPa labels are rendered on the graph"
    - "Tidal timeline renders a smooth curve showing high/low water events on a canvas"
    - "Tidal timeline marks high/low tide times with labels and height values in meters"
  artifacts:
    - path: "fishing-app/js/sparkline.js"
      provides: "drawPressureSparkline function that renders 48h pressure trend on canvas"
      exports: ["drawPressureSparkline"]
      min_lines: 40
    - path: "fishing-app/js/tidal-chart.js"
      provides: "drawTidalTimeline function that renders day tidal curve on canvas"
      exports: ["drawTidalTimeline"]
      min_lines: 40
  key_links:
    - from: "fishing-app/js/sparkline.js"
      to: "Canvas 2D API"
      via: "canvas.getContext('2d')"
      pattern: "getContext\\('2d'\\)"
    - from: "fishing-app/js/tidal-chart.js"
      to: "Canvas 2D API"
      via: "canvas.getContext('2d')"
      pattern: "getContext\\('2d'\\)"
---

<objective>
Create Canvas-based visualization components for the 48-hour pressure trend sparkline and the tidal timeline chart.

Purpose: These are the two graphical elements in the expanded day detail view. The pressure sparkline goes in the "Luftdruck" group and the tidal timeline goes in the "Marine" group. Both use pure Canvas 2D API with zero external dependencies, consistent with the app's vanilla JS approach.

Output: Two new JS files (sparkline.js, tidal-chart.js) that export rendering functions accepting canvas elements and data arrays.
</objective>

<execution_context>
@C:\Users\Lucas Benutzer\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Lucas Benutzer\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-weather-enhancement/01-RESEARCH.md
@fishing-app/js/config.js
@fishing-app/js/utils.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sparkline.js - 48h pressure trend Canvas renderer</name>
  <files>fishing-app/js/sparkline.js</files>
  <action>
Create fishing-app/js/sparkline.js following existing codebase conventions (JSDoc header, function docs, CommonJS export at bottom).

**Function: `drawPressureSparkline(canvas, pressureData, nowIndex)`**

Parameters:
- `canvas` - HTMLCanvasElement (will be sized by CSS, use canvas.width/height for drawing)
- `pressureData` - Array of `{ time: string, value: number }` (48 entries, 24h past + 24h future)
- `nowIndex` - Integer index in pressureData marking "now" (the current hour)

Implementation details per user's locked decision:

1. **Canvas setup:**
   - Get 2D context
   - Handle high-DPI displays: `const dpr = window.devicePixelRatio || 1; canvas.width = canvas.offsetWidth * dpr; canvas.height = canvas.offsetHeight * dpr; ctx.scale(dpr, dpr);` Then use offsetWidth/offsetHeight as logical dimensions.
   - Clear canvas
   - Define padding: `{ top: 12, right: 30, bottom: 12, left: 10 }`

2. **Data scaling:**
   - Filter out null/undefined values from pressureData
   - Find min/max pressure values
   - Create scaleX(index) and scaleY(value) functions mapping data to canvas coordinates
   - Use logical width/height (offsetWidth/offsetHeight) for scaling

3. **Draw color-coded background zones** (per locked decision: green=falling/good, orange=stable, red=rising):
   - For each consecutive pair of data points, compute pressure difference
   - `diff < -0.3`: green zone `rgba(34, 197, 94, 0.15)` (falling = good for fishing)
   - `diff > 0.3`: red zone `rgba(239, 68, 68, 0.15)` (rising)
   - else: orange zone `rgba(245, 158, 11, 0.15)` (stable)
   - Draw as fillRect strips from top to bottom of canvas

4. **Draw pressure line:**
   - Blue line: `strokeStyle = '#0ea5e9'`, `lineWidth = 2`
   - Use beginPath/moveTo/lineTo pattern iterating over all valid data points
   - Skip null values (don't break the line, just skip to next valid point)

5. **Draw "now" marker** (per locked decision: vertical dashed line):
   - If nowIndex is valid (>= 0 and < data length):
   - White dashed line: `strokeStyle = '#ffffff'`, `lineWidth = 1`, `setLineDash([3, 3])`
   - Draw vertical line from top to bottom at scaleX(nowIndex)
   - Draw a small filled circle (4px radius) at the intersection with the pressure line
   - Reset dash: `setLineDash([])`

6. **Draw min/max hPa labels** (per locked decision: just min/max values, compact):
   - Right-aligned text at top-right and bottom-right
   - `fillStyle = '#94a3b8'`, `font = '10px system-ui, sans-serif'`
   - Top: `Math.round(max) + ' hPa'`
   - Bottom: `Math.round(min) + ' hPa'`

7. **Performance:** This function should be callable multiple times (accordion expand/collapse). Each call clears and redraws. No caching needed for initial implementation -- Canvas draws of ~48 points are fast enough.

**No external dependencies.** Pure Canvas 2D API.

Add CommonJS export at bottom: `if (typeof module !== 'undefined' && module.exports) { module.exports = { drawPressureSparkline }; }`
  </action>
  <verify>
    - File fishing-app/js/sparkline.js exists
    - Function drawPressureSparkline is defined with 3 parameters (canvas, pressureData, nowIndex)
    - Contains getContext('2d') call
    - Contains devicePixelRatio handling for crisp rendering on mobile
    - Contains colored zone rendering (green rgba for falling, red rgba for rising, orange rgba for stable)
    - Contains "now" marker rendering with setLineDash
    - Contains min/max hPa label rendering
    - Has CommonJS export at bottom
    - No external library imports (no Chart.js, no SVG libraries)
  </verify>
  <done>
    sparkline.js renders a 48h pressure trend sparkline on canvas with color-coded zones, "now" marker, and min/max labels. Compact sparkline style (~100px height target). Zero external dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create tidal-chart.js - Tidal timeline Canvas renderer</name>
  <files>fishing-app/js/tidal-chart.js</files>
  <action>
Create fishing-app/js/tidal-chart.js following existing codebase conventions.

**Function: `drawTidalTimeline(canvas, tides, dayStartHour, dayEndHour)`**

Parameters:
- `canvas` - HTMLCanvasElement
- `tides` - Array of `{ time: ISO string, height: number, type: 'high'|'low' }` for one day (typically 2-4 events)
- `dayStartHour` - Number (0-23), typically 0 for full day view
- `dayEndHour` - Number (0-23), typically 23

Implementation details per user's locked decision (graphical timeline showing tidal curve with high/low water times AND heights in meters):

1. **Canvas setup:**
   - Same high-DPI handling as sparkline.js
   - Clear canvas
   - Padding: `{ top: 14, right: 10, bottom: 20, left: 10 }`

2. **Generate smooth tidal curve:**
   - The tides array only has 2-4 discrete points (high/low events)
   - Generate a smooth sinusoidal interpolation between tide events
   - Create ~24 interpolated points (one per hour) using cosine interpolation between consecutive tide events:
     ```
     For hours between tide[i] and tide[i+1]:
       progress = (hour - tide[i].hour) / (tide[i+1].hour - tide[i].hour)
       height = tide[i].height + (tide[i+1].height - tide[i].height) * (0.5 - 0.5 * cos(PI * progress))
     ```
   - This produces a natural tidal S-curve between known high/low points

3. **Draw filled area under curve:**
   - Gradient fill from water blue to transparent: `createLinearGradient` from top to bottom
   - Top color: `rgba(56, 189, 248, 0.3)` (light blue)
   - Bottom color: `rgba(56, 189, 248, 0.05)` (near transparent)
   - Fill below the curve line down to the bottom axis

4. **Draw tidal curve line:**
   - Smooth blue line: `strokeStyle = '#38bdf8'`, `lineWidth = 2`
   - Draw through all interpolated points

5. **Mark high/low tide events:**
   - For each tide in the tides array:
   - Draw a filled circle (5px radius) at the tide position on the curve
   - High tide: `fillStyle = '#22d3ee'` (cyan)
   - Low tide: `fillStyle = '#818cf8'` (indigo)
   - Draw time label ABOVE high tides, BELOW low tides
   - Format: "HH:MM" + height in meters, e.g., "14:30 (1.2m)"
   - `font = '9px system-ui, sans-serif'`
   - `fillStyle = '#cbd5e1'` (light gray for readability on dark backgrounds)

6. **Draw time axis:**
   - Light horizontal line at bottom: `strokeStyle = 'rgba(148, 163, 184, 0.3)'`
   - Time markers every 6 hours: "00:00", "06:00", "12:00", "18:00"
   - `font = '9px system-ui, sans-serif'`, `fillStyle = '#64748b'`

7. **Handle edge cases:**
   - If tides array is empty, draw a flat line with text "Keine Gezeitendaten"
   - If only 1 tide event, draw it as a peak/trough with extrapolated curve
   - Handle tides that might wrap around midnight

**No external dependencies.** Pure Canvas 2D API.

Add CommonJS export at bottom: `if (typeof module !== 'undefined' && module.exports) { module.exports = { drawTidalTimeline }; }`
  </action>
  <verify>
    - File fishing-app/js/tidal-chart.js exists
    - Function drawTidalTimeline is defined with correct parameters
    - Contains cosine interpolation logic for smooth curve generation
    - Contains gradient fill below curve
    - Contains high/low tide markers with time and height labels
    - Contains time axis with hour markers
    - Handles empty tides array gracefully
    - Has CommonJS export at bottom
    - No external library imports
  </verify>
  <done>
    tidal-chart.js renders a tidal timeline curve on canvas showing the day's tidal pattern with high/low water markers displaying times and heights in meters. Smooth sinusoidal interpolation between known tide events. Zero external dependencies.
  </done>
</task>

</tasks>

<verification>
1. Both sparkline.js and tidal-chart.js exist in fishing-app/js/
2. Both use pure Canvas 2D API (no external charting library)
3. Both handle high-DPI displays (devicePixelRatio)
4. Sparkline renders color-coded background zones + "now" marker + min/max labels
5. Tidal chart renders smooth curve + high/low markers with height values + time axis
6. Both handle edge cases (null data, empty arrays)
7. Both have JSDoc documentation and CommonJS exports
8. Neither file imports or depends on any external library
</verification>

<success_criteria>
Two canvas rendering utilities exist that can be called from the accordion UI:
- drawPressureSparkline(canvas, pressureData, nowIndex) renders the 48h pressure sparkline per WETTER-12
- drawTidalTimeline(canvas, tides) renders the tidal timeline per WETTER-10
Both are compact, performant, and consistent with the app's zero-dependency vanilla JS approach.
</success_criteria>

<output>
After completion, create `.planning/phases/01-weather-enhancement/01-02-SUMMARY.md`
</output>
