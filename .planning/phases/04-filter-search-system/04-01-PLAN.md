---
phase: 04-filter-search-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fishing-app/js/fish-ui.js
  - fishing-app/css/style.css
autonomous: false

must_haves:
  truths:
    - "User enables 'Suisswasser' toggle and sees only freshwater fish (waterTypes containing fluss/see/bach/teich)"
    - "User enables 'Salzwasser' toggle and sees only saltwater fish (waterTypes containing meer/kueste/brackwasser)"
    - "User enables 'Was beisst jetzt?' toggle and sees only fish whose bestMonths includes the current month"
    - "User enables 'Essbar' toggle and sees only fish with edibility.rating >= 3"
    - "User combines multiple filters and sees the AND intersection of all active filters"
    - "User sees result counter ('X Arten gefunden') that updates in real-time as filters change"
    - "User can clear all filters with one button and see all 201 fish again"
    - "Existing category filters (Alle/Raubfisch/Friedfisch/Salmonide/Salzwasser/Meeresfruechte) still work"
    - "Existing text search still works and combines with new filters via AND logic"
  artifacts:
    - path: "fishing-app/js/fish-ui.js"
      provides: "Filter logic (water type, season, edibility) + filter UI + result counter"
      contains: "SALTWATER_TYPES|FRESHWATER_TYPES|matchesWaterTypeFilter|matchesSeasonFilter|matchesEdibilityFilter|filterState"
    - path: "fishing-app/css/style.css"
      provides: "Styles for filter row, result counter, active filter states"
      contains: "fish-filter-row|result-counter"
  key_links:
    - from: "fishing-app/js/fish-ui.js"
      to: "renderFishSearch filter buttons"
      via: "addEventListener click handlers toggle filterState and call applyFilter()"
      pattern: "filterState\\."
    - from: "fishing-app/js/fish-ui.js"
      to: "result counter DOM element"
      via: "applyFilter updates counter text after filtering"
      pattern: "Arten gefunden|Art gefunden"
---

<objective>
Implement multi-dimensional fish filtering (water type, season, edibility) with combined AND logic, result counter, and clear-all functionality.

Purpose: Users with 201+ fish species need fast filtering to find relevant species. This phase adds water type (salt/fresh), season ("Was beisst jetzt?"), and edibility filters that combine with existing category and text search filters.

Output: Enhanced fish-ui.js with filter logic/UI and style.css with filter styles. All 6 FILTER requirements met.
</objective>

<execution_context>
@C:/Users/Lucas Benutzer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lucas Benutzer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-filter-search-system/04-RESEARCH.md

# Key source files
@fishing-app/js/fish-ui.js
@fishing-app/css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add filter state, filter logic, filter UI, and result counter to fish-ui.js</name>
  <files>fishing-app/js/fish-ui.js</files>
  <action>
Modify `renderFishSearch()` function in fish-ui.js to add multi-dimensional filtering. The changes are:

**1. Add filter constants at module top level (before renderFishSearch):**
```javascript
var SALTWATER_TYPES = ['meer', 'kueste', 'brackwasser'];
var FRESHWATER_TYPES = ['fluss', 'see', 'bach', 'teich'];
var EDIBILITY_THRESHOLD = 3;
```

**2. Add pure filter functions (before renderFishSearch):**
- `matchesWaterTypeFilter(fish, saltwater, freshwater)` — Returns true if no water filter active, or if fish.waterTypes (array) contains any type from the active group(s). Defensive: return false if fish.waterTypes is missing or not an array. OR logic between salt and fresh (show fish if it matches either selected group).
- `matchesSeasonFilter(fish, enabled)` — Returns true if not enabled, or if fish.season.bestMonths includes current month (1-12 via `new Date().getMonth() + 1`). Defensive: return false if fish.season or fish.season.bestMonths is missing.
- `matchesEdibilityFilter(fish, enabled)` — Returns true if not enabled, or if fish.edibility.rating >= EDIBILITY_THRESHOLD. Defensive: return false if fish.edibility is missing.
- `formatResultCount(count)` — Returns German string: count === 0 ? 'Keine Arten gefunden' : count === 1 ? '1 Art gefunden' : count + ' Arten gefunden'

**3. Refactor renderFishSearch() to add filter state and new UI elements:**

Add a centralized `filterState` object inside renderFishSearch:
```javascript
var filterState = {
    searchText: '',
    category: 'alle',
    saltwater: false,
    freshwater: false,
    seasonEnabled: false,
    edibilityEnabled: false
};
```

**After the existing search bar, BEFORE category filters, add a new filter row:**

Create a `div` with class `fish-filter-row` containing these toggle buttons (each as `<button>` with class `fish-filter-btn`):

a) **Suesswasser** button — text "Suesswasser", toggles filterState.freshwater on click. When active, add class `active` and set `aria-pressed="true"`.

b) **Salzwasser** button — text "Salzwasser", toggles filterState.saltwater on click. Same active pattern.

c) **Season** button — text should include current month name: `'Was beisst jetzt? (' + monthName + ')'` where monthName is from `new Date().toLocaleDateString('de-DE', { month: 'long' })`. Toggles filterState.seasonEnabled. Same active pattern.

d) **Edibility** button — text "Essbar", toggles filterState.edibilityEnabled. Same active pattern.

e) **Clear All** button — text "Zuruecksetzen", class `fish-filter-btn fish-filter-btn--reset`, only visible when any filter is active. On click: resets all filterState fields to defaults, removes `active` from all filter buttons, resets category to 'alle', clears search input, calls applyFilter(). Hide this button via `style.display = 'none'` when no filters are active.

**After the category filter bar, add a result counter:**

Create a `div` with class `fish-result-counter`, set `aria-live="polite"` and `aria-atomic="true"`. Initial text: formatResultCount(fishData.length).

**4. Update applyFilter() to use all filter dimensions:**

Replace the existing filter logic with:
```javascript
function applyFilter() {
    filterState.searchText = input.value.trim().toLowerCase();
    filterState.category = activeCategory;

    var filtered = fishData.filter(function(fish) {
        var matchesCategory = filterState.category === 'alle' || fish.category === filterState.category;
        var matchesSearch = !filterState.searchText ||
            fish.name.toLowerCase().indexOf(filterState.searchText) !== -1 ||
            fish.scientificName.toLowerCase().indexOf(filterState.searchText) !== -1 ||
            fish.family.toLowerCase().indexOf(filterState.searchText) !== -1 ||
            (fish.nicknames && fish.nicknames.some(function(n) { return n.toLowerCase().indexOf(filterState.searchText) !== -1; }));
        var matchesWater = matchesWaterTypeFilter(fish, filterState.saltwater, filterState.freshwater);
        var matchesSeason = matchesSeasonFilter(fish, filterState.seasonEnabled);
        var matchesEdibility = matchesEdibilityFilter(fish, filterState.edibilityEnabled);

        return matchesCategory && matchesSearch && matchesWater && matchesSeason && matchesEdibility;
    });

    // Update result counter
    resultCounter.textContent = formatResultCount(filtered.length);

    // Show/hide reset button
    var anyFilterActive = filterState.category !== 'alle' ||
        filterState.searchText !== '' ||
        filterState.saltwater || filterState.freshwater ||
        filterState.seasonEnabled || filterState.edibilityEnabled;
    resetBtn.style.display = anyFilterActive ? '' : 'none';

    onFilter(filtered);
}
```

**5. Accessibility:**
- All toggle buttons: `aria-pressed="true|false"` toggled on click
- Result counter: `aria-live="polite"` and `aria-atomic="true"`

**Important implementation notes:**
- Use `var` declarations (matching existing code style, not const/let)
- Use `function` syntax (not arrow functions) per existing patterns
- Use `.indexOf()` not `.includes()` for string search (matches existing pattern)
- Use `addEventListener('click', ...)` per existing pattern
- Keep the `debounce(applyFilter, 250)` on the search input event listener
- Filter toggle clicks should call `applyFilter()` immediately (no debounce)
- Keep `activeCategory` variable for backward compat with existing category filter logic
  </action>
  <verify>
Open the app in browser. Verify:
1. New filter buttons appear between search bar and category filters
2. Clicking each filter button toggles its active state (visual + aria-pressed)
3. Result counter appears below category filters showing "201 Arten gefunden" initially
4. Clicking "Suesswasser" filters to only freshwater fish (count decreases)
5. Clicking "Essbar" additionally filters to edible freshwater fish (count decreases further)
6. Clicking "Zuruecksetzen" clears all filters and shows 201 fish again
7. Text search still works and combines with toggle filters
8. Category buttons still work and combine with toggle filters
  </verify>
  <done>
All 6 FILTER requirements implemented: water type filter (FILTER-01), season filter (FILTER-02), edibility filter (FILTER-03), text search preserved (FILTER-04), AND logic combining all filters (FILTER-05), result counter with German grammar (FILTER-06). Clear-all button resets all state. Accessibility attributes present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS styles for filter row, filter buttons, result counter, and enhanced empty state</name>
  <files>fishing-app/css/style.css</files>
  <action>
Add new CSS rules in style.css, placed after the existing `.fish-category-btn` styles (around line 1264). Insert the following styles:

**1. Filter row container:**
```css
.fish-filter-row {
    display: flex;
    gap: 6px;
    overflow-x: auto;
    padding: 0 0 4px;
    scrollbar-width: none;
}

.fish-filter-row::-webkit-scrollbar {
    display: none;
}
```
This mirrors the existing `.fish-category-filters` pattern for horizontal scroll.

**2. Filter toggle buttons:**
```css
.fish-filter-btn {
    height: 36px;
    padding: 0 14px;
    border-radius: 18px;
    border: 1.5px solid var(--color-border);
    background: transparent;
    color: var(--color-text-secondary);
    font-size: 0.85rem;
    font-family: inherit;
    cursor: pointer;
    white-space: nowrap;
    flex-shrink: 0;
    transition: background 0.15s, color 0.15s, border-color 0.15s;
}

.fish-filter-btn.active {
    background: var(--color-primary);
    color: var(--color-text-inverse);
    border-color: var(--color-primary);
}

.fish-filter-btn:hover:not(.active) {
    border-color: var(--color-primary-light);
    color: var(--color-primary);
}

.fish-filter-btn:active {
    transform: scale(0.96);
}
```
These match the existing `.fish-category-btn` visual pattern exactly.

**3. Reset button variant:**
```css
.fish-filter-btn--reset {
    border-color: var(--color-accent);
    color: var(--color-accent);
}

.fish-filter-btn--reset:hover {
    background: var(--color-accent);
    color: var(--color-text-inverse);
    border-color: var(--color-accent);
}
```
Uses the accent color (gold/amber) to visually distinguish from regular filter buttons.

**4. Result counter:**
```css
.fish-result-counter {
    font-size: 0.82rem;
    color: var(--color-text-secondary);
    padding: 6px 0 2px;
    text-align: left;
}
```
Subtle, non-distracting counter below the filter bars.

**5. Add `.fish-filter-btn:active` to the existing button press feedback rule** (around line 310). Find the rule:
```css
.btn-icon:active,
.fish-category-btn:active,
```
and add `.fish-filter-btn:active,` to the selector list so it gets the same `transform: scale(0.96)` feedback.

**6. Responsive adjustments** — The filter row uses the same `overflow-x: auto` pattern as category filters, so it should already work on mobile. No additional media queries needed.

**Important:** Use the existing CSS custom properties (--color-primary, --color-border, --color-text-secondary, --color-text-inverse, --color-accent, --color-primary-light) to ensure the filters match both dark and light theme modes.
  </action>
  <verify>
1. Open app, verify filter buttons have pill shape matching existing category buttons
2. Click a filter button — verify it turns turquoise (active state)
3. Check dark mode: buttons have correct contrast and readability
4. Check light mode (if toggle exists): buttons adapt correctly
5. On mobile viewport (375px width): filter row scrolls horizontally without breaking layout
6. Result counter text is subtle, left-aligned below filters
7. Reset button has gold/amber accent color distinguishing it from filter buttons
  </verify>
  <done>
Filter UI styled to match existing marine design system. Pill buttons, active states, hover effects, reset button accent color, result counter, responsive horizontal scroll, dark/light theme compatible.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete filter system works end-to-end</name>
  <files>fishing-app/js/fish-ui.js, fishing-app/css/style.css</files>
  <action>
Human verification checkpoint. Multi-dimensional fish filter system with water type (Suesswasser/Salzwasser), season (Was beisst jetzt?), edibility (Essbar) filters, result counter, and clear-all button. Combined with existing category and text search filters using AND logic.

Steps to verify:
1. Open fishing-app/index.html in browser
2. Navigate to fish section (scroll down or tap fish tab if exists)
3. Verify all 201 fish visible and result counter shows "201 Arten gefunden"
4. Click "Suesswasser" — verify only freshwater fish shown, counter updates
5. Click "Salzwasser" additionally — verify both fresh AND saltwater fish shown (OR within water type), counter increases
6. Click "Suesswasser" again to disable — verify only saltwater fish remain
7. Click "Was beisst jetzt? (Februar)" — verify counter decreases (AND logic with water type)
8. Click "Essbar" — verify counter decreases further (only edible saltwater fish in season)
9. Type "Forelle" in search — verify it filters further within active filters
10. Click "Zuruecksetzen" — verify ALL filters cleared, search input cleared, 201 fish shown
11. Verify category buttons (Raubfisch, Friedfisch, etc.) still work correctly
12. Check mobile responsive: filter rows scroll horizontally on narrow viewport
  </action>
  <verify>User confirms all 12 verification steps pass. Type "approved" or describe issues.</verify>
  <done>All FILTER-01 through FILTER-06 requirements verified by human testing. Filter system is production-ready.</done>
</task>

</tasks>

<verification>
Phase 4 verification checklist:
- [ ] FILTER-01: Water type filter works (Suesswasser shows freshwater, Salzwasser shows saltwater)
- [ ] FILTER-02: Season filter shows only fish active in current month
- [ ] FILTER-03: Edibility filter shows only fish with rating >= 3
- [ ] FILTER-04: Text search still works (existing functionality preserved)
- [ ] FILTER-05: All filters combine with AND logic (intersection)
- [ ] FILTER-06: Result counter updates in real-time with correct German grammar
- [ ] Clear-all button resets all filters
- [ ] Existing category filters still work
- [ ] Accessibility: aria-pressed on toggles, aria-live on counter
- [ ] Responsive: horizontal scroll on mobile
- [ ] Themed: matches dark marine design system
</verification>

<success_criteria>
1. User can filter 201 fish by water type (salt/fresh) and see correct results
2. User can filter by current season ("Was beisst jetzt?") and see only in-season fish
3. User can filter by edibility and see only fish rated >= 3
4. User can combine all filters (water + season + edibility + category + text) with AND logic
5. Result counter shows correct count with German grammar ("X Arten gefunden")
6. "Zuruecksetzen" button clears all filters and restores full catalog
7. All existing search and category filter functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-filter-search-system/04-01-SUMMARY.md`
</output>
