---
phase: 05-navigation-favorites
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - fishing-app/js/app.js
  - fishing-app/sw.js
autonomous: false

must_haves:
  truths:
    - "User taps heart icon and sees instant visual toggle (no delay)"
    - "Favorite persists after app reload (IndexedDB write succeeds)"
    - "If IndexedDB write fails, heart button reverts to previous state"
    - "User opens Favorites tab and sees all saved fish"
    - "Favorites work offline (already saved fish display without network)"
  artifacts:
    - path: "fishing-app/js/app.js"
      provides: "Optimistic UI toggleFavorite with rollback on error"
      contains: "Optimistic"
    - path: "fishing-app/sw.js"
      provides: "Service worker cache v5"
      contains: "v5"
  key_links:
    - from: "fishing-app/js/app.js toggleFavorite"
      to: "fishing-app/js/storage.js addFavorite/removeFavorite"
      via: "async IndexedDB write after optimistic UI update"
      pattern: "await.*(addFavorite|removeFavorite)"
    - from: "fishing-app/sw.js"
      to: "fishing-app/index.html"
      via: "APP_SHELL cache list"
      pattern: "APP_SHELL"
---

<objective>
Implement optimistic UI for favorites toggle (instant heart button feedback with IndexedDB rollback on error) and bump service worker cache to v5 for deployment.

Purpose: The current toggleFavorite waits for IndexedDB before updating in-memory state, causing a perceptible delay. Optimistic UI provides instant feedback. Service worker v5 ensures users get the updated 3-tab layout.

Output: Instant-feel favorites toggle with error rollback, service worker cache v5.
</objective>

<execution_context>
@C:/Users/Lucas Benutzer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lucas Benutzer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-navigation-favorites/05-RESEARCH.md
@.planning/phases/05-navigation-favorites/05-01-SUMMARY.md
@fishing-app/js/app.js
@fishing-app/js/storage.js
@fishing-app/sw.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement optimistic UI for favorites toggle with rollback</name>
  <files>fishing-app/js/app.js</files>
  <action>
**Replace the existing `toggleFavorite()` function in app.js (currently around lines 1215-1235) with an optimistic UI version:**

The current implementation:
```javascript
async function toggleFavorite(fishId) {
    try {
        var idx = favoriteIds.indexOf(fishId);
        if (idx !== -1) {
            await removeFavorite(fishId);
            favoriteIds.splice(idx, 1);
        } else {
            await addFavorite(fishId);
            favoriteIds.push(fishId);
        }
        // Update aria-pressed...
    } catch (e) {
        console.error('Favorit-Aenderung fehlgeschlagen:', e);
    }
}
```

Replace with:
```javascript
async function toggleFavorite(fishId) {
    var idx = favoriteIds.indexOf(fishId);
    var wasAdding = idx === -1;

    // Optimistic update: modify in-memory state FIRST
    if (wasAdding) {
        favoriteIds.push(fishId);
    } else {
        favoriteIds.splice(idx, 1);
    }

    // Update UI immediately (heart button in fish detail)
    var favBtn = document.getElementById('fish-fav-btn');
    if (favBtn) {
        favBtn.classList.toggle('is-favorite', wasAdding);
        favBtn.innerHTML = wasAdding ? '&#9829;' : '&#9825;';
        favBtn.setAttribute('aria-pressed', String(wasAdding));
    }

    // Persist to IndexedDB asynchronously
    try {
        if (wasAdding) {
            await addFavorite(fishId);
        } else {
            await removeFavorite(fishId);
        }
    } catch (e) {
        // Rollback on error: revert in-memory state
        if (wasAdding) {
            var rollbackIdx = favoriteIds.indexOf(fishId);
            if (rollbackIdx !== -1) favoriteIds.splice(rollbackIdx, 1);
        } else {
            favoriteIds.push(fishId);
        }

        // Rollback UI
        if (favBtn) {
            favBtn.classList.toggle('is-favorite', !wasAdding);
            favBtn.innerHTML = !wasAdding ? '&#9829;' : '&#9825;';
            favBtn.setAttribute('aria-pressed', String(!wasAdding));
        }

        console.error('Favorit-Aenderung fehlgeschlagen:', e);
    }
}
```

**Also update `onFishSelect()`** to remove the duplicate UI update logic. Currently the `renderFishDetail` call in `onFishSelect` passes an `onFavToggle` callback that calls `toggleFavorite(fish.id)`. The fish-ui.js `renderFishDetail` also toggles the button state on click (lines 321-326 of fish-ui.js). Now that `toggleFavorite` handles the UI update directly, we need to prevent the double-toggle.

**In fish-ui.js `renderFishDetail()`**, the favorite button click handler currently does:
```javascript
favBtn.addEventListener('click', function () {
    onFavToggle();
    var isNowFav = favBtn.classList.toggle('is-favorite');
    favBtn.innerHTML = isNowFav ? '&#9829;' : '&#9825;';
    favBtn.setAttribute('aria-pressed', isNowFav ? 'true' : 'false');
});
```

Change this to ONLY call `onFavToggle()` and let `toggleFavorite` handle the UI:
```javascript
favBtn.addEventListener('click', function () {
    onFavToggle();
});
```

**What to AVOID and WHY:**
- Do NOT store full fish objects in favorites - only IDs (already correct, keep it that way).
- Do NOT block the UI thread by awaiting IndexedDB before updating the heart button.
- Do NOT forget the rollback - if the await fails, the UI must revert.
- Do NOT remove the `renderFishDetail` heart button's `is-favorite` class initialization from the initial render (line 279 of fish-ui.js). Only change the click handler.
  </action>
  <verify>
1. Open app, navigate to Fish tab, tap any fish to see detail.
2. Tap heart button - it should toggle instantly (no visible delay).
3. Tap heart button again - it should toggle back instantly.
4. Close and reopen app - favorites should persist.
5. Open browser DevTools, check for any console errors during toggle.
6. Switch to Favorites tab after toggling - favorite fish should appear/disappear correctly.

Run: `grep -c "Optimistic\|Rollback\|rollback" fishing-app/js/app.js` should return at least 2 comment matches.
Run: `grep "onFavToggle" fishing-app/js/fish-ui.js` should show the simplified click handler.
  </verify>
  <done>
Heart button toggles instantly on tap. IndexedDB persistence happens asynchronously. If IndexedDB write fails, the button reverts to its previous state. fish-ui.js click handler no longer duplicates the UI toggle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Bump service worker cache to v5</name>
  <files>fishing-app/sw.js</files>
  <action>
**In sw.js:**

1. Change `CACHE_VERSION` from `'v4'` to `'v5'` (line 10).

This single change will:
- Force all clients to download the new 3-tab index.html
- Clear the v4 cache on activation (the activate handler already deletes old caches)
- Re-cache all APP_SHELL files with the updated content

**What to AVOID and WHY:**
- Do NOT change the APP_SHELL list - all files are already listed correctly.
- Do NOT change cache strategy logic - it already works.
- Do NOT change the activate handler - it already cleans old caches.
  </action>
  <verify>
Run: `grep "CACHE_VERSION" fishing-app/sw.js` should show `'v5'`.
Run: `grep "CACHE_NAME" fishing-app/sw.js` should show `'petri-heil-v5'` (computed).
  </verify>
  <done>
Service worker cache version is v5. On next deployment, users will get the updated app with 3-tab navigation and optimistic favorites.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 5 implementation</name>
  <files>fishing-app/index.html, fishing-app/js/app.js, fishing-app/js/fish-ui.js, fishing-app/sw.js</files>
  <action>
Human verification of the complete Navigation and Favorites system:
- 3-tab bottom navigation (Weather, Fish, Favorites) with forecast merged into Weather
- Hash-based URL routing for bookmarkable tabs
- Optimistic UI for heart button favorites toggle
- Service worker v5 for deployment

Steps to verify:
1. Open the app in browser. Verify bottom bar has exactly 3 tabs: Wetter, Fische, Favoriten.
2. In the Weather tab, scroll down. Verify you see: current weather, sun/moon, catch summary, hourly forecast, 7-day accordion, AND catch breakdown details - all in one scrollable view.
3. Click "Fische" tab. Verify URL changes to #fish. Fish catalog with filters appears.
4. Click "Favoriten" tab. Verify URL changes to #favorites.
5. Navigate to a URL like index.html#fish directly - should open on Fish tab.
6. Click through tabs: Weather -> Fish -> Favorites. Use browser back button - should navigate back through Fish -> Weather.
7. In Fish tab, tap any fish card to see detail. Tap the heart button - should toggle INSTANTLY (solid/outline heart).
8. Tap heart again to toggle back. Should be instant.
9. With a fish favorited, switch to Favorites tab - the fish should appear.
10. Reload the page - favorites should persist.
11. Verify no console errors during all operations.
  </action>
  <verify>Type "approved" or describe any issues found</verify>
  <done>All Phase 5 success criteria verified by human: 3-tab navigation works, hash routing works, favorites toggle is instant, favorites persist across reload.</done>
</task>

</tasks>

<verification>
1. Heart icon toggles instantly with no visible delay
2. Favorites persist across page reload (IndexedDB)
3. Favorites tab shows all saved fish
4. Service worker cache version is v5
5. 3-tab navigation still works correctly after optimistic UI changes
6. No console errors during favorites toggle
</verification>

<success_criteria>
- [ ] Heart button feedback is instant (optimistic UI)
- [ ] IndexedDB rollback works on error
- [ ] Fish detail heart handler doesn't double-toggle
- [ ] Service worker cache is v5
- [ ] All Phase 5 success criteria verified by human
</success_criteria>

<output>
After completion, create `.planning/phases/05-navigation-favorites/05-02-SUMMARY.md`
</output>
