---
phase: 06-offline-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - fishing-app/sw.js
  - fishing-app/js/utils.js
  - fishing-app/js/app.js
autonomous: true

must_haves:
  truths:
    - "User goes offline and all 62 fish SVG images load from cache"
    - "User sees 'Letzte Aktualisierung: vor X Stunden' when viewing cached weather data offline"
    - "User goes offline and sees offline banner, banner disappears when back online"
    - "Fish catalog data (fish-data.json) and all images are fully available offline"
  artifacts:
    - path: "fishing-app/sw.js"
      provides: "Service worker v6 with fish SVG image caching"
      contains: "petri-heil-v6"
    - path: "fishing-app/js/utils.js"
      provides: "Relative time formatter for cache timestamps"
      contains: "formatRelativeTime"
    - path: "fishing-app/js/app.js"
      provides: "Offline banner wiring and improved weather timestamp display"
      contains: "navigator.onLine"
  key_links:
    - from: "fishing-app/sw.js"
      to: "images/fish/*.svg"
      via: "APP_SHELL array includes all 62 fish SVG paths"
      pattern: "images/fish/.*\\.svg"
    - from: "fishing-app/js/app.js"
      to: "fishing-app/js/utils.js"
      via: "formatRelativeTime called for cached weather timestamp"
      pattern: "formatRelativeTime"
---

<objective>
Make the app fully functional offline by caching all fish images in the service worker, wiring up offline/online detection with a visible banner, and showing a human-readable relative timestamp for cached weather data.

Purpose: Users at the water without internet can still browse the complete fish catalog with images and see when weather data was last refreshed.
Output: Service worker v6 with complete fish image caching, offline banner logic, relative time weather timestamps.
</objective>

<execution_context>
@C:/Users/Lucas Benutzer/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lucas Benutzer/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@fishing-app/sw.js
@fishing-app/js/utils.js
@fishing-app/js/app.js
@fishing-app/js/config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cache all fish SVG images in service worker v6</name>
  <files>fishing-app/sw.js</files>
  <action>
Update sw.js to cache all 62 fish SVG images for complete offline access:

1. Bump CACHE_VERSION from 'v5' to 'v6' (line 10). This updates both CACHE_NAME and API_CACHE_NAME automatically.

2. Add all 62 fish SVG paths to the APP_SHELL array. The paths must be relative with './' prefix to match the existing pattern. Add them after the existing entries (after './manifest.json'):

```
'./images/icon.svg',
'./images/fish/aal.svg',
'./images/fish/aalrutte.svg',
'./images/fish/aesche.svg',
'./images/fish/aland.svg',
'./images/fish/bachforelle.svg',
'./images/fish/bachsaibling.svg',
'./images/fish/barbe.svg',
'./images/fish/bonito.svg',
'./images/fish/brachse.svg',
'./images/fish/doebel.svg',
'./images/fish/dorsch.svg',
'./images/fish/elritze.svg',
'./images/fish/flunder.svg',
'./images/fish/flussbarsch.svg',
'./images/fish/giebel.svg',
'./images/fish/goldbrasse.svg',
'./images/fish/gruendling.svg',
'./images/fish/hasel.svg',
'./images/fish/hecht.svg',
'./images/fish/hering.svg',
'./images/fish/hornhecht.svg',
'./images/fish/huchen.svg',
'./images/fish/kalmar.svg',
'./images/fish/karausche.svg',
'./images/fish/karpfen.svg',
'./images/fish/kaulbarsch.svg',
'./images/fish/knurrhahn.svg',
'./images/fish/koppe.svg',
'./images/fish/lachs.svg',
'./images/fish/makrele.svg',
'./images/fish/meeraal.svg',
'./images/fish/meeraesche.svg',
'./images/fish/meerbrasse.svg',
'./images/fish/meerforelle.svg',
'./images/fish/nase.svg',
'./images/fish/oktopus.svg',
'./images/fish/petersfisch.svg',
'./images/fish/rapfen.svg',
'./images/fish/regenbogenforelle.svg',
'./images/fish/renke.svg',
'./images/fish/rotauge.svg',
'./images/fish/rotbarbe.svg',
'./images/fish/rotfeder.svg',
'./images/fish/sardine.svg',
'./images/fish/schleie.svg',
'./images/fish/scholle.svg',
'./images/fish/seeforelle.svg',
'./images/fish/seesaibling.svg',
'./images/fish/seeteufel.svg',
'./images/fish/seezunge.svg',
'./images/fish/sepia.svg',
'./images/fish/steinbutt.svg',
'./images/fish/sterlet.svg',
'./images/fish/stint.svg',
'./images/fish/streber.svg',
'./images/fish/thunfisch.svg',
'./images/fish/ukelei.svg',
'./images/fish/wels.svg',
'./images/fish/wolfsbarsch.svg',
'./images/fish/zahnbrasse.svg',
'./images/fish/zander.svg',
'./images/fish/zingel.svg'
```

3. The install event already does `cache.addAll(APP_SHELL)` which will cache all fish images on first load. No changes needed to install/activate/fetch handlers.

4. The cache-first strategy for static assets (default in the fetch handler) already serves cached images, so fish SVGs will be served from cache when offline.

NOTE: Do NOT change CONFIG.CACHE_NAME in config.js -- it is out of sync with sw.js (shows v1) and is not actually used by the service worker. The service worker has its own hardcoded version.
  </action>
  <verify>
Open sw.js and confirm:
- CACHE_VERSION is 'v6'
- APP_SHELL array contains 62 fish SVG paths plus images/icon.svg (63 image entries total)
- All paths use './' prefix
- No other logic changed
  </verify>
  <done>Service worker v6 caches all 62 fish SVGs + icon.svg on install, guaranteeing complete offline fish catalog with images.</done>
</task>

<task type="auto">
  <name>Task 2: Add relative time formatter and wire offline banner + weather timestamp</name>
  <files>fishing-app/js/utils.js, fishing-app/js/app.js</files>
  <action>
**Part A: Add formatRelativeTime to utils.js**

Add a new function at the end of utils.js (before the module.exports block if it exists, or at the very end):

```javascript
/**
 * Formats a timestamp as relative time in German
 * @param {number} timestamp - Unix timestamp in milliseconds
 * @returns {string} e.g. "vor 5 Minuten", "vor 2 Stunden", "vor 1 Tag"
 */
function formatRelativeTime(timestamp) {
    var now = Date.now();
    var diffMs = now - timestamp;
    var diffSec = Math.floor(diffMs / 1000);
    var diffMin = Math.floor(diffSec / 60);
    var diffHours = Math.floor(diffMin / 60);
    var diffDays = Math.floor(diffHours / 24);

    if (diffMin < 1) return 'gerade eben';
    if (diffMin < 60) return 'vor ' + diffMin + (diffMin === 1 ? ' Minute' : ' Minuten');
    if (diffHours < 24) return 'vor ' + diffHours + (diffHours === 1 ? ' Stunde' : ' Stunden');
    if (diffDays < 7) return 'vor ' + diffDays + (diffDays === 1 ? ' Tag' : ' Tagen');
    // Fallback: absolute date
    var d = new Date(timestamp);
    return d.toLocaleDateString('de-AT') + ' ' + d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
}
```

Also add `formatRelativeTime` to the module.exports if the exports block exists in utils.js.

**Part B: Wire offline/online detection in app.js**

In the `init()` function of app.js (the main IIFE), add online/offline event listeners. Find where event listeners are set up (near the DOMContentLoaded or init function) and add:

```javascript
// Offline/Online detection
window.addEventListener('online', function() {
    var banner = $('offline-banner');
    if (banner) banner.hidden = true;
});

window.addEventListener('offline', function() {
    var banner = $('offline-banner');
    if (banner) banner.hidden = false;
});

// Check initial state
if (!navigator.onLine) {
    var banner = $('offline-banner');
    if (banner) banner.hidden = false;
}
```

**Part C: Improve weather cache timestamp display in app.js**

In the `loadWeatherData()` function catch block (around line 620-645), replace the existing timestamp display:

Current code (around line 623-645):
```javascript
var cachedTime = new Date(cached.timestamp);
var timeStr = cachedTime.getHours().toString().padStart(2, '0') + ':' + cachedTime.getMinutes().toString().padStart(2, '0');
// ... later ...
setTextContent('weather-time', 'Daten von ' + timeStr);
```

Replace with relative time:
```javascript
var relativeStr = formatRelativeTime(cached.timestamp);
// ... keep all rendering logic ...
setTextContent('weather-time', 'Letzte Aktualisierung: ' + relativeStr);
```

Also add staleness indicator: after setting the weather-time text, check if the cached data is older than 6 hours (21600000 ms). If so, add a visual indicator. Find the weather-time element and add a CSS class:
```javascript
var weatherTimeEl = $('weather-time');
if (weatherTimeEl) {
    var ageMs = Date.now() - cached.timestamp;
    if (ageMs > 6 * 60 * 60 * 1000) {
        weatherTimeEl.classList.add('weather-time--stale');
    }
}
```

Do NOT change the successful weather fetch path (line 691 where it shows "Aktualisiert: HH:MM") -- that remains for live data display.
  </action>
  <verify>
1. Check utils.js contains formatRelativeTime function
2. Check app.js has window.addEventListener('online', ...) and window.addEventListener('offline', ...)
3. Check app.js catch block uses formatRelativeTime for cached weather display
4. Check app.js has navigator.onLine initial state check
  </verify>
  <done>
- formatRelativeTime function exists in utils.js and produces German relative time strings
- Offline banner shows/hides automatically based on network state
- Cached weather displays "Letzte Aktualisierung: vor X Stunden" instead of raw time
- Weather data older than 6 hours gets visual staleness indicator
  </done>
</task>

</tasks>

<verification>
1. Open sw.js and count fish SVG entries in APP_SHELL (should be 62)
2. Verify CACHE_VERSION is 'v6'
3. Open utils.js and check formatRelativeTime is defined and exported
4. Open app.js and verify online/offline event listeners exist
5. Open app.js and verify cached weather uses formatRelativeTime
6. Check that icon.svg is in APP_SHELL
</verification>

<success_criteria>
- Service worker v6 pre-caches all 62 fish SVGs and icon.svg on install
- App detects offline/online state and shows/hides banner accordingly
- Cached weather data shows human-readable relative timestamp in German
- Stale weather data (>6h) is visually indicated
</success_criteria>

<output>
After completion, create `.planning/phases/06-offline-enhancement/06-01-SUMMARY.md`
</output>
