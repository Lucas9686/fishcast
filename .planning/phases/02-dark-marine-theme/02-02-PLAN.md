---
phase: 02-dark-marine-theme
plan: 02
type: execute
wave: 2
depends_on: [01]
files_modified:
  - fishing-app/js/app.js
  - fishing-app/sw.js
autonomous: false

must_haves:
  truths:
    - "User clicks theme toggle and cycles through dark/light/auto modes"
    - "User's theme preference persists across page refreshes"
    - "User switches to auto mode and app follows system dark/light preference"
    - "User scrolls and cards fade in smoothly on viewport entry"
    - "User switches tabs and sees turquoise pulse micro-interaction"
    - "Theme switch shows smooth 300ms color fade transition"
  artifacts:
    - path: "fishing-app/js/app.js"
      provides: "ThemeToggle class, Intersection Observer card fade-in, tab pulse trigger"
      contains: "ThemeToggle"
    - path: "fishing-app/sw.js"
      provides: "Updated cache version for forced update"
      contains: "v3"
  key_links:
    - from: "fishing-app/js/app.js"
      to: "fishing-app/index.html"
      via: "ThemeToggle reads btn-theme-toggle element, sets data-theme on documentElement"
      pattern: "btn-theme-toggle"
    - from: "fishing-app/js/app.js"
      to: "fishing-app/css/style.css"
      via: "adds/removes CSS classes (tab-pulse, fade-in-hidden, fade-in-visible, theme-transition)"
      pattern: "tab-pulse|fade-in"
---

<objective>
Implement the ThemeToggle JavaScript class for three-mode cycling (dark/light/auto), add Intersection Observer for card fade-in animations, add tab pulse micro-interaction trigger, and bump service worker cache version.

Purpose: Brings the CSS theme system from Plan 01 to life with interactive JS. After this plan, users can actively toggle themes, cards animate on scroll, and tab switches have visual feedback.

Output: Updated app.js with ThemeToggle class and micro-interactions, updated sw.js with cache version bump.
</objective>

<execution_context>
@C:\Users\Lucas Benutzer\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Lucas Benutzer\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-CONTEXT.md
@.planning/phases/02-dark-marine-theme/02-RESEARCH.md
@.planning/phases/02-dark-marine-theme/02-01-SUMMARY.md
@fishing-app/js/app.js
@fishing-app/sw.js
@fishing-app/index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement ThemeToggle class and integrate into app init</name>
  <files>fishing-app/js/app.js</files>
  <action>
Add a ThemeToggle class inside the existing IIFE in app.js, BEFORE the init() function. This class manages theme cycling, localStorage persistence, icon updates, and system preference tracking.

**Step 1: Add ThemeToggle class**

Place AFTER the DOM References section and BEFORE the Initialization section:

```javascript
    // ============================================================
    // Theme Toggle
    // ============================================================
    var THEME_MODES = ['dark', 'light', 'auto'];
    var THEME_ICONS = { dark: '\u{1F319}', light: '\u{2600}\uFE0F', auto: '\u{1F504}' };
    var THEME_LABELS = { dark: 'Dunkel', light: 'Hell', auto: 'Auto' };
    var THEME_STORAGE_KEY = 'theme';

    /**
     * ThemeToggle - Manages dark/light/auto theme cycling
     * Reads/writes localStorage, sets data-theme attribute on <html>,
     * updates meta theme-color, listens for system preference changes.
     */
    function ThemeToggle() {
        this.button = $('btn-theme-toggle');
        if (!this.button) return;

        this.currentTheme = this._getStored() || 'auto';
        this._applyTheme(this.currentTheme);
        this._updateIcon();
        this._bindEvents();
    }

    ThemeToggle.prototype._getStored = function() {
        try {
            return localStorage.getItem(THEME_STORAGE_KEY);
        } catch (e) {
            return null;
        }
    };

    ThemeToggle.prototype._save = function(theme) {
        try {
            localStorage.setItem(THEME_STORAGE_KEY, theme);
        } catch (e) {
            console.warn('Theme-Einstellung konnte nicht gespeichert werden');
        }
    };

    ThemeToggle.prototype._applyTheme = function(theme) {
        var resolvedTheme;
        if (theme === 'auto') {
            resolvedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        } else {
            resolvedTheme = theme;
        }
        document.documentElement.setAttribute('data-theme', resolvedTheme);

        // Update meta theme-color for mobile browser chrome
        var metaTheme = document.querySelector('meta[name="theme-color"]');
        if (metaTheme) {
            metaTheme.setAttribute('content', resolvedTheme === 'dark' ? '#0d1b2a' : '#00bcd4');
        }
    };

    ThemeToggle.prototype._updateIcon = function() {
        this.button.textContent = THEME_ICONS[this.currentTheme];
        this.button.setAttribute('aria-label', 'Theme: ' + THEME_LABELS[this.currentTheme]);
        this.button.setAttribute('title', 'Theme: ' + THEME_LABELS[this.currentTheme]);
    };

    ThemeToggle.prototype.toggle = function() {
        // Add transition class for smooth color fade
        document.documentElement.classList.add('theme-transition');

        var currentIndex = THEME_MODES.indexOf(this.currentTheme);
        var nextIndex = (currentIndex + 1) % THEME_MODES.length;
        this.currentTheme = THEME_MODES[nextIndex];

        this._save(this.currentTheme);
        this._applyTheme(this.currentTheme);
        this._updateIcon();

        // Remove transition class after fade completes (300ms)
        var self = this;
        setTimeout(function() {
            document.documentElement.classList.remove('theme-transition');
        }, 350);
    };

    ThemeToggle.prototype._bindEvents = function() {
        var self = this;

        // Click to cycle through themes
        this.button.addEventListener('click', function() {
            self.toggle();
        });

        // Listen for system preference changes (applies when in auto mode)
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function() {
            if (self.currentTheme === 'auto') {
                self._applyTheme('auto');
            }
        });
    };
```

**Step 2: Initialize ThemeToggle in init()**

Add `new ThemeToggle();` in the init() function, AFTER setupTabs() and BEFORE setupLocationSearch(). The theme toggle should initialize early since it affects the entire UI:

```javascript
        // Setup theme toggle
        new ThemeToggle();
```

**Step 3: Verify the function uses the existing `$` helper**

The class uses `$('btn-theme-toggle')` which maps to `document.getElementById` -- this is already defined in app.js as `const $ = (id) => document.getElementById(id);`. Verify this works correctly.
  </action>
  <verify>
Open fishing-app/js/app.js and verify:
1. ThemeToggle function/class exists with _applyTheme, toggle, _updateIcon, _save, _getStored, _bindEvents methods
2. THEME_MODES array contains ['dark', 'light', 'auto']
3. new ThemeToggle() is called in init()
4. toggle() adds 'theme-transition' class and removes after 350ms
5. matchMedia listener calls _applyTheme('auto') when system preference changes
6. Meta theme-color is updated on theme apply
  </verify>
  <done>Theme toggle button cycles dark -> light -> auto, persists to localStorage, smooth 300ms color fade on switch, respects system preference in auto mode, icon and aria-label update correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add card fade-in Intersection Observer and tab pulse micro-interaction</name>
  <files>fishing-app/js/app.js</files>
  <action>
Add two micro-interactions to app.js: (1) Intersection Observer for card fade-in on scroll, (2) tab pulse effect on tab switch.

**Step 1: Add card fade-in observer**

Add a new function AFTER the ThemeToggle class, BEFORE the init() function:

```javascript
    // ============================================================
    // Card Fade-In on Scroll
    // ============================================================
    /**
     * setupCardFadeIn - Uses Intersection Observer to animate cards
     * entering the viewport. Cards start hidden and fade in once.
     * Disabled when user prefers reduced motion.
     */
    function setupCardFadeIn() {
        // Skip if user prefers reduced motion
        if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
            return;
        }

        var observer = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    entry.target.classList.remove('fade-in-hidden');
                    entry.target.classList.add('fade-in-visible');
                    observer.unobserve(entry.target);
                }
            });
        }, {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        });

        // Observe all cards currently in the DOM
        document.querySelectorAll('.card').forEach(function(card) {
            card.classList.add('fade-in-hidden');
            observer.observe(card);
        });
    }
```

Call `setupCardFadeIn()` in init(), AFTER `renderFavoritesSection()` (near the end of init, so all cards are rendered first).

**Step 2: Add tab pulse to setupTabs()**

Modify the existing `setupTabs()` function. Inside the click handler, AFTER `switchTab(tab.id, targetId)`, add the pulse trigger:

```javascript
                // Tab pulse micro-interaction
                if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    tab.classList.add('tab-pulse');
                    tab.addEventListener('animationend', function removePulse() {
                        tab.classList.remove('tab-pulse');
                        tab.removeEventListener('animationend', removePulse);
                    });
                }
```

This should be added INSIDE the existing click handler, after the switchTab call but within the same event listener. It goes AFTER the existing press feedback setTimeout block.

The complete modified setupTabs function should look like:

```javascript
    function setupTabs() {
        var tabs = document.querySelectorAll('.tab-bar__tab');
        tabs.forEach(function (tab) {
            tab.addEventListener('click', function () {
                // Visual press feedback
                tab.style.transform = 'scale(0.93)';
                tab.classList.add('tab-pressed');
                setTimeout(function() {
                    tab.style.transform = '';
                    tab.classList.remove('tab-pressed');
                }, 150);

                var targetId = tab.getAttribute('aria-controls');
                switchTab(tab.id, targetId);

                // Tab pulse micro-interaction
                if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                    tab.classList.add('tab-pulse');
                    tab.addEventListener('animationend', function removePulse() {
                        tab.classList.remove('tab-pulse');
                        tab.removeEventListener('animationend', removePulse);
                    });
                }
            });
        });
    }
```
  </action>
  <verify>
Open fishing-app/js/app.js and verify:
1. setupCardFadeIn function exists with IntersectionObserver
2. Observer uses threshold: 0.1 and rootMargin: '0px 0px -50px 0px'
3. Observer adds 'fade-in-visible' and removes 'fade-in-hidden' class
4. prefers-reduced-motion check prevents observer setup when reduce is active
5. setupCardFadeIn() is called in init() after renderFavoritesSection()
6. setupTabs click handler includes tab-pulse logic with animationend listener
7. Tab pulse also checks prefers-reduced-motion
  </verify>
  <done>Cards fade in smoothly when scrolling into viewport (animate once, then stay visible), tab switches trigger turquoise pulse animation, both micro-interactions respect prefers-reduced-motion</done>
</task>

<task type="auto">
  <name>Task 3: Bump service worker cache version</name>
  <files>fishing-app/sw.js</files>
  <action>
Update the service worker cache version to force a cache refresh for the rethemed files.

Change line 10 of sw.js:

```javascript
const CACHE_VERSION = 'v3';
```

This ensures that when users receive the update, the old cached CSS/JS files (with green theme) are replaced with the new marine-themed versions.

Also verify that the APP_SHELL array includes all files that were modified (css/style.css, js/app.js, index.html) -- these should already be listed.
  </action>
  <verify>
Open fishing-app/sw.js and verify:
1. CACHE_VERSION is 'v3' (was 'v2')
2. APP_SHELL includes './css/style.css', './js/app.js', './index.html'
  </verify>
  <done>Service worker cache version bumped to v3, forcing cache refresh for all rethemed files on next update</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete dark marine theme with interactive toggle, micro-interactions, and visual polish</what-built>
  <how-to-verify>
    1. Open fishing-app/index.html in a browser
    2. Verify dark marine blue background (#0d1b2a) with turquoise accents -- no green remnants
    3. Verify "Petri Heil" branding is turquoise colored
    4. Verify cards have subtle turquoise glow/shadow effect
    5. Verify subtle animated wave pattern moves slowly in background
    6. Click theme toggle button (next to map button in header):
       - First click: should switch to Light mode (light background, turquoise accents)
       - Second click: should switch to Auto mode (follows OS setting)
       - Third click: back to Dark mode
       - Verify smooth ~300ms color fade on each switch
       - Verify icon changes: moon -> sun -> auto-arrows
    7. Refresh page -- theme preference should persist (no flicker)
    8. Click weather accordion days -- verify smooth 0.25s expand/collapse
    9. Switch tabs -- verify turquoise pulse animation on tab click
    10. Scroll down -- verify cards fade in as they enter viewport
    11. On mobile or with narrow viewport: verify all touch targets >= 44px, layout responsive
    12. Enable "Reduce Motion" in OS accessibility settings:
        - Wave background should stop animating
        - Tab pulse should not appear
        - Card fade-in should be instant (no animation)
        - Accordion should open/close without transition
  </how-to-verify>
  <resume-signal>Type "approved" if everything looks correct, or describe specific issues</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Theme toggle cycles dark -> light -> auto correctly with icon updates
2. Theme persists in localStorage across page refreshes
3. No white/green flash on any page load in dark mode
4. Auto mode follows system preference and updates live when OS setting changes
5. Cards fade in on scroll (once per card, then stay visible)
6. Tab pulse fires on tab switch (turquoise ring effect)
7. Service worker cache bumped to v3
8. All micro-interactions disabled when prefers-reduced-motion is active
9. Complete dark marine theme with no forest-green remnants
</verification>

<success_criteria>
- Theme toggle button works: dark -> light -> auto cycling
- localStorage persistence: reload page, same theme applied
- Anti-flicker: no white flash on dark mode load
- System preference tracking: auto mode follows OS, updates on change
- Card fade-in: IntersectionObserver triggers once per card
- Tab pulse: turquoise pulse on tab switch
- Service worker: cache v3 forces fresh download
- prefers-reduced-motion: ALL decorative animations disabled
- No JavaScript errors in console
</success_criteria>

<output>
After completion, create `.planning/phases/02-dark-marine-theme/02-02-SUMMARY.md`
</output>
