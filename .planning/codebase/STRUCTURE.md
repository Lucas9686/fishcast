# Codebase Structure

**Analysis Date:** 2026-02-07

## Directory Layout

```
fishing-app/
├── index.html              # Main entry point, HTML structure (335 lines)
├── manifest.json           # PWA manifest configuration
├── sw.js                   # Service Worker for offline caching
├── css/
│   └── style.css           # All styling (responsive, mobile-first)
├── js/
│   ├── config.js           # Centralized configuration, type definitions (364 lines)
│   ├── app.js              # Main controller, state management, orchestration (1062 lines)
│   ├── api.js              # Weather and geocoding API calls (100+ lines)
│   ├── solunar.js          # Moon phases, solunar periods, catch probability
│   ├── storage.js          # IndexedDB persistence (favorites, history, settings)
│   ├── map.js              # Leaflet map integration (80+ lines)
│   ├── fish-ui.js          # Fish list, detail, and search rendering (80+ lines)
│   └── utils.js            # Formatting, utilities, debounce (100+ lines)
├── data/
│   └── fish-data.json      # Fish species catalog (all metadata)
├── images/
│   ├── icon.svg            # PWA icon
│   └── fish/               # 40+ fish species SVG images (aal.svg, hecht.svg, etc.)
├── generate-fish-svgs.js   # Build script for generating fish SVGs
└── FISHING_REVIEW.md       # Project documentation
```

## Directory Purposes

**Root:**
- Purpose: PWA entry point and configuration
- Contains: HTML shell, app manifest, service worker registration, stylesheets, deferred script loading
- Key files: `index.html`, `manifest.json`

**js/**
- Purpose: Application logic split by layer and responsibility
- Contains: Configuration, API calls, calculations, storage, UI rendering, state management
- Key files: `config.js` (shared contracts), `app.js` (orchestration)
- Load order (defined in index.html lines 325-332): config → utils → api → solunar → storage → map → fish-ui → app

**data/**
- Purpose: Static data assets
- Contains: Fish species catalog with metadata
- Key files: `fish-data.json` (loaded at runtime in app.js line 51)

**images/**
- Purpose: Visual assets
- Contains: App icon (SVG) and 40+ fish illustration SVGs
- Generated by: `generate-fish-svgs.js` (Canvas pixel art to SVG)

**css/**
- Purpose: All styling (no CSS preprocessor)
- Contains: Mobile-first responsive design, component classes, layout, animations

## Key File Locations

**Entry Points:**
- `index.html` (line 1): Loads manifest, stylesheets, defers all scripts
- `js/app.js` (line 30): DOMContentLoaded handler, calls init()
- `manifest.json` (line 1): PWA metadata, app name, icons, shortcuts

**Configuration:**
- `js/config.js` (line 12): CONFIG object with API endpoints, defaults, constants
- `js/config.js` (line 115): CATCH_WEIGHTS for probability calculation
- `js/config.js` (line 126): MOON_PHASES array (8 phases with emoji and scores)
- `js/config.js` (line 140): WEATHER_CODES mapping WMO codes to German text/emojis
- `js/config.js` (line 172): CATCH_RATINGS thresholds and colors
- `js/config.js` (line 180+): JSDoc type definitions (LocationData, WeatherData, FishSpecies, etc.)

**Core Logic:**
- `js/app.js` (line 10-20): Application state variables
- `js/app.js` (line 329): setLocation() - Location change handler
- `js/app.js` (line 362): loadWeatherData() - Weather fetch + calculation
- `js/app.js` (line 458): refreshData() - Auto-refresh timer callback
- `js/app.js` (line 842): renderFishUI() - Fish section initialization

**API & Data:**
- `js/api.js` (line 44): fetchWeatherData() - Open-Meteo call with retry
- `js/api.js` (line 202): searchLocation() - Geocoding via Open-Meteo
- `js/solunar.js` (line 38): getMoonData() - Lunar phase calculation
- `js/solunar.js` (line 150+): getSolunarPeriods() - Solunar time calculation
- `js/solunar.js` (line 200+): calculateCatchProbability() - Weighted factor scoring
- `data/fish-data.json`: Array of FishSpecies objects, loaded in app.js line 51

**Storage & Persistence:**
- `js/storage.js` (line 13): initDB() - IndexedDB setup
- `js/storage.js` (line 75): addFavorite() - Add fish to favorites
- `js/storage.js` (line 120+): getFavorites() - Load favorite list
- `js/storage.js` (line 200+): addToHistory() - Store location in history
- Service Worker `sw.js`: Caches app shell and API responses for offline

**UI Rendering:**
- `js/fish-ui.js` (line 12): renderFishList() - Grid of fish cards
- `js/fish-ui.js` (line 71): renderFishDetail() - Full fish species detail view
- `js/fish-ui.js` (line 300+): renderFishSearch() - Search + filter UI
- `js/map.js` (line 20): initMap() - Leaflet setup
- `js/app.js` (line 467): renderWeatherDashboard() - Current conditions display
- `js/app.js` (line 491): renderAstroData() - Sun/moon times
- `js/app.js` (line 532): renderCatchSummary() - Gauge + rating
- `js/app.js` (line 591): renderHourlyForecast() - 24-hour scroll
- `js/app.js` (line 665): renderDailyForecast() - 7-day accordion

**Testing:**
- No test files present (no testing framework detected)

## Naming Conventions

**Files:**
- Lowercase kebab-case for HTML/CSS files: `index.html`, `style.css`
- Lowercase for JS modules: `config.js`, `api.js`, `fish-ui.js`
- Underscore-prefixed JS files (none standard): `sw.js` (service worker)
- Fish SVG images: kebab-case fish names: `hecht.svg`, `bachforelle.svg`, `meerforelle.svg`

**Functions:**
- camelCase for all functions: `fetchWeatherData()`, `getMoonData()`, `renderFishList()`
- Private/internal functions start with underscore: `_esc()` (XSS escape), `_map`, `_marker`, `_db`
- Async functions use async/await pattern: `async function fetchWeatherData()`

**Variables:**
- camelCase for local variables: `currentLocation`, `currentWeather`, `fishData`
- UPPER_SNAKE_CASE for constants: `CONFIG`, `CATCH_WEIGHTS`, `MOON_PHASES`, `WEATHER_CODES`, `CATCH_RATINGS`
- Prefix with underscore for module-private globals: `_db`, `_map`, `_marker`, `_fishListScrollY`

**CSS Classes:**
- BEM (Block Element Modifier) convention:
  - Block: `.card`, `.fish-grid`, `.tab-bar`, `.hourly-slider`
  - Element: `.card__header`, `.fish-card__image`, `.tab-bar__tab`
  - Modifier: `.card--weather`, `.fish-card__category--raubfisch`, `.section.active`
  - State: `.is-expanded`, `.is-now`, `.has-overflow`, `.skeleton-text`

**DOM IDs:**
- kebab-case: `#current-location`, `#weather-icon`, `#map-container`, `#section-weather`
- Purpose-based: `#[purpose]-[component]` or `#[purpose]-[action]`

**Data Attributes:**
- None used (rely on data properties and ARIA attributes instead)

## Where to Add New Code

**New Feature (Weather-related):**
- Primary code: Add calculation to `js/solunar.js` or extend API call in `js/api.js`
- Rendering: Add render function in `js/app.js` or extend existing render
- Styling: Add BEM component to `css/style.css`
- Config: Add constants to `CONFIG` object in `js/config.js` if needed

**New Component/Module (Fish detail subsection):**
- Create `js/my-feature.js` if more than 100 lines, otherwise extend `js/fish-ui.js`
- Export functions matching pattern: `function renderMyFeature(container, data, callback)`
- Add to script loading order in `index.html` BEFORE `js/app.js`
- Call from appropriate place in `js/app.js` orchestration
- Add type definitions to `js/config.js` JSDoc section if introducing new data type

**Utilities (Formatting helpers):**
- Add to `js/utils.js` as standalone function: `function formatMyValue(val) { ... }`
- No dependencies except other utils functions
- Use pattern: check if value is valid with `Number.isFinite()` or `if (!val) return '–'`
- Export by making global (no module system used)

**New Section (Tab-based page):**
1. Add `<section id="section-myfeature" class="section">` to `index.html` content area
2. Add tab button `<button id="tab-myfeature" class="tab-bar__tab" role="tab">` to nav
3. Add tab ID to `CONFIG.SECTIONS` and `CONFIG.TABS` in `js/config.js`
4. Create `renderMyfeatureSection()` in `js/app.js`
5. Add tab switch case: `if (sectionId === CONFIG.SECTIONS.MYFEATURE) { renderMyfeatureSection(); }`
6. Call initial render in `init()` function

**New Fish Species (adding to catalog):**
- Edit or regenerate `data/fish-data.json` with new FishSpecies object
- Follow shape defined in `js/config.js` lines 275-307
- Ensure category is one of: `"raubfisch"`, `"friedfisch"`, `"salmonide"`, `"salzwasser"`, `"meeresfruechte"`
- Add SVG image to `images/fish/[fish-id].svg` (kebab-case filename)
- Update `image` property in fish-data.json to match: `"images/fish/[fish-id].svg"`

**Storage/Cache (new IndexedDB store):**
- Define store name in `CONFIG.DB.STORES` in `js/config.js`
- Add object store creation to `initDB()` in `js/storage.js` within `request.onupgradeneeded`
- Create CRUD functions in `js/storage.js` following existing pattern (async, Promise-based)
- Update `CONFIG.DB.VERSION` to increment migrations

**Offline/Caching:**
- Cache API responses in `sw.js` (Service Worker)
- Store user data in IndexedDB via `js/storage.js`
- Add fallback UI state for offline scenarios in `js/app.js` error handlers
- Use `getCachedWeather()` pattern for offline data retrieval

## Special Directories

**node_modules:**
- Purpose: Not used (no build process, vanilla JavaScript)
- Generated: N/A
- Committed: N/A
- Note: No package.json (static site)

**images/fish/:**
- Purpose: Fish species illustrations
- Generated: By `generate-fish-svgs.js` script (Canvas → SVG)
- Committed: Yes (SVG files)
- Note: 40+ SVGs, one per fish species, kebab-case naming

**Service Worker Cache:**
- Purpose: Offline asset storage
- Generated: Runtime (browser IndexedDB + Cache API)
- Committed: No (ephemeral)
- Managed by: `sw.js` (CACHE_VERSION control)

## File Dependencies Graph

```
index.html
├── manifest.json (referenced)
├── css/style.css
├── Leaflet library (CDN: leaflet.css + leaflet.js)
└── js/[deferred] in order:
    ├── config.js (no deps)
    ├── utils.js (no deps, uses CONFIG)
    ├── api.js (deps: CONFIG, utils)
    ├── solunar.js (deps: CONFIG)
    ├── storage.js (deps: CONFIG)
    ├── map.js (deps: CONFIG, Leaflet, utils)
    ├── fish-ui.js (no deps on other app modules)
    └── app.js (deps: ALL above, fish-data.json)

data/fish-data.json
└── loaded by app.js at runtime

js/app.js
├── calls renderFishUI() which uses renderFishList/renderFishDetail from fish-ui.js
├── calls initMap() from map.js
├── calls fetchWeatherData() from api.js
├── calls getMoonData(), getSolunarPeriods(), calculateCatchProbability() from solunar.js
├── calls storage functions (initDB, addFavorite, getFavorites, etc.) from storage.js
└── calls utils functions (formatTemperature, debounce, etc.) from utils.js
```

## Load Order and Initialization

**Critical ordering (defined in index.html lines 325-332):**

1. `config.js` - Must load first, all modules depend on CONFIG
2. `utils.js` - Pure utilities, used by api.js and others
3. `api.js` - Weather API calls, depends on CONFIG and utils
4. `solunar.js` - Calculations, depends on CONFIG
5. `storage.js` - IndexedDB, depends on CONFIG
6. `map.js` - Leaflet integration, depends on CONFIG and utils
7. `fish-ui.js` - Rendering functions, can depend on utils
8. `app.js` - Main controller, depends on ALL above

**Why order matters:**
- `config.js` first: All modules read CONFIG object
- `api.js` before `app.js`: fetchWeatherData() called during init
- `map.js` before `app.js`: initMap() called on demand from app.js
- `solunar.js` before `app.js`: Calculations needed for weather rendering
- `storage.js` before `app.js`: initDB() called in app.js init()

**Deferred loading:** All scripts use `defer` attribute, so DOM is ready when scripts execute, and they execute in order.

---

*Structure analysis: 2026-02-07*
